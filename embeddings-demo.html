<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Embeddings Visualizer</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/reactflow@11.10.1/dist/umd/index.js"></script>
    <script src="https://unpkg.com/three@0.159.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three-spritetext@1.8.1/dist/three-spritetext.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.74.1/dist/3d-force-graph.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.1/dist/style.css">
    <script>
        // Make sure we can access the imported libraries
        console.log('ReactFlow UMD loaded:', window.ReactFlow ? 'Yes' : 'No');
        console.log('Three.js loaded:', window.THREE ? 'Yes' : 'No');
        console.log('ForceGraph3D loaded:', window.ForceGraph3D ? 'Yes' : 'No');
    </script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .control-button:hover {
            background-color: #2563eb !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .control-button:active {
            background-color: #1d4ed8 !important;
            transform: translateY(1px);
        }
        
        .control-button.active {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        
        /* Enhance 3D visualization */
        canvas {
            cursor: grab;
        }
        
        canvas:active {
            cursor: grabbing;
        }
        
        .custom-node {
            padding: 8px 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 2px solid white;
            background: white;
            min-width: 80px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .custom-node:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .node-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 auto 4px;
        }
        
        .node-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }
        
        .node-category {
            font-size: 11px;
            color: #6B7280;
        }
        
        .control-panel {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 10;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E7EB;
        }
        
        .info-panel {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 10;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E7EB;
            max-width: 300px;
        }
        
        .legend {
            position: absolute;
            bottom: 16px;
            left: 16px;
            z-index: 10;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E7EB;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .control-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .control-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useMemo } = React;
        const { ReactFlow, Background, Controls, MiniMap, useNodesState, useEdgesState } = window.ReactFlow;

        // Sample embedding data
        const embeddingData = [
            // Programming concepts cluster
            { id: 'javascript', label: 'JavaScript', x: 100, y: 100, z: 50, category: 'programming', color: '#3b82f6', vector: [0.23, -0.52, 0.81, -0.14] },
            { id: 'python', label: 'Python', x: 150, y: 120, z: 80, category: 'programming', color: '#3b82f6', vector: [0.31, -0.48, 0.73, -0.21] },
            { id: 'react', label: 'React', x: 80, y: 150, z: 30, category: 'programming', color: '#3b82f6', vector: [0.18, -0.58, 0.76, -0.09] },
            { id: 'nodejs', label: 'Node.js', x: 120, y: 80, z: 60, category: 'programming', color: '#3b82f6', vector: [0.26, -0.55, 0.79, -0.12] },
            { id: 'github', label: 'GitHub', x: 180, y: 140, z: 90, category: 'programming', color: '#3b82f6', vector: [0.35, -0.46, 0.68, -0.25] },
            
            // Animal concepts cluster
            { id: 'cat', label: 'Cat', x: 400, y: 300, z: -50, category: 'animals', color: '#10b981', vector: [0.82, 0.47, 0.21, -0.18] },
            { id: 'dog', label: 'Dog', x: 450, y: 280, z: -80, category: 'animals', color: '#10b981', vector: [0.79, 0.52, 0.18, -0.22] },
            { id: 'tiger', label: 'Tiger', x: 380, y: 350, z: -60, category: 'animals', color: '#10b981', vector: [0.75, 0.42, 0.26, -0.15] },
            { id: 'elephant', label: 'Elephant', x: 500, y: 320, z: -70, category: 'animals', color: '#10b981', vector: [0.68, 0.38, 0.31, -0.12] },
            
            // Food concepts cluster
            { id: 'pizza', label: 'Pizza', x: 250, y: 450, z: 120, category: 'food', color: '#f59e0b', vector: [-0.42, 0.76, -0.35, 0.28] },
            { id: 'pasta', label: 'Pasta', x: 280, y: 420, z: 150, category: 'food', color: '#f59e0b', vector: [-0.39, 0.72, -0.38, 0.32] },
            { id: 'sushi', label: 'Sushi', x: 320, y: 470, z: 140, category: 'food', color: '#f59e0b', vector: [-0.45, 0.68, -0.41, 0.25] },
            { id: 'burger', label: 'Burger', x: 220, y: 480, z: 110, category: 'food', color: '#f59e0b', vector: [-0.38, 0.74, -0.32, 0.36] },
            { id: 'chef', label: 'Chef', x: 300, y: 400, z: 130, category: 'food', color: '#f59e0b', vector: [-0.35, 0.65, -0.45, 0.30] },
            
            // Transportation cluster
            { id: 'car', label: 'Car', x: 600, y: 150, z: -150, category: 'transport', color: '#ef4444', vector: [-0.68, -0.56, -0.21, 0.62] },
            { id: 'airplane', label: 'Airplane', x: 650, y: 120, z: -180, category: 'transport', color: '#ef4444', vector: [-0.72, -0.52, -0.18, 0.58] },
            { id: 'bicycle', label: 'Bicycle', x: 580, y: 200, z: -120, category: 'transport', color: '#ef4444', vector: [-0.65, -0.61, -0.24, 0.65] },
            { id: 'train', label: 'Train', x: 630, y: 180, z: -160, category: 'transport', color: '#ef4444', vector: [-0.70, -0.58, -0.22, 0.61] },
        ];

        // Custom node component
        const CustomNode = ({ data }) => {
            return (
                <div className="custom-node">
                    <div className="node-color" style={{ backgroundColor: data.color }}></div>
                    <div className="node-label">{data.label}</div>
                    <div className="node-category">{data.category}</div>
                    <div className="node-vector" style={{ fontSize: '8px', color: '#666', marginTop: '2px' }}>
                        [{data.vector ? data.vector.map(v => v.toFixed(2)).join(', ') : ''}]
                    </div>
                </div>
            );
        };

        const nodeTypes = {
            custom: CustomNode,
        };

        function EmbeddingVisualizer() {
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [showSimilarity, setShowSimilarity] = useState(false);
            const [selectedNode, setSelectedNode] = useState(null);
            const [distanceMetric, setDistanceMetric] = useState('euclidean');
            const [threshold, setThreshold] = useState(0.7);
            // Keep a backup of the original node positions
            const [originalNodePositions, setOriginalNodePositions] = useState({});
            // Toggle between 2D and 3D view
            const [is3DView, setIs3DView] = useState(false);
            // Reference to the 3D graph container
            const graphRef = React.useRef(null);
            const graph3DInstanceRef = React.useRef(null);

            // Convert embedding data to ReactFlow nodes
            const initialNodes = useMemo(() => {
                // Create a positions object to store original positions
                const positions = {};
                
                const nodes = embeddingData.map((item) => {
                    // Store the original position
                    positions[item.id] = { x: item.x, y: item.y };
                    
                    return {
                        id: item.id,
                        type: 'custom',
                        position: { x: item.x, y: item.y },
                        data: { 
                            label: item.label, 
                            category: item.category, 
                            color: item.color,
                            vector: item.vector,
                            originalData: item 
                        },
                    };
                });
                
                // Save the original positions for reset functionality
                setOriginalNodePositions(positions);
                
                return nodes;
            }, []);

            // Calculate similarity based on different metrics
            const calculateDistance = useCallback((vector1, vector2, metric) => {
                // Helper functions for vector calculations
                const dotProduct = (a, b) => a.reduce((sum, val, i) => sum + val * b[i], 0);
                const magnitude = vec => Math.sqrt(vec.reduce((sum, val) => sum + val * val, 0));
                
                switch (metric) {
                    case 'euclidean':
                        return Math.sqrt(vector1.reduce((sum, val, i) => sum + Math.pow(val - vector2[i], 2), 0));
                    case 'cosine':
                        const dot = dotProduct(vector1, vector2);
                        const magA = magnitude(vector1);
                        const magB = magnitude(vector2);
                        return 1 - (dot / (magA * magB)); // Cosine distance (1 - cosine similarity)
                    case 'dot':
                        return 1 - ((dotProduct(vector1, vector2) + 1) / 2); // Normalized to [0,1] range
                    default:
                        return Math.sqrt(vector1.reduce((sum, val, i) => sum + Math.pow(val - vector2[i], 2), 0));
                }
            }, []);

            // Calculate similarity edges
            const calculateSimilarityEdges = useCallback((metric = distanceMetric) => {
                const edges = [];
                const maxDistance = {
                    euclidean: 2.0,  // Approximate max for our vectors
                    cosine: 1.0,    // Max cosine distance is 1
                    dot: 1.0        // Our normalized dot distance is [0,1]
                };
                
                const thresholdDistance = threshold * maxDistance[metric];
                
                for (let i = 0; i < embeddingData.length; i++) {
                    for (let j = i + 1; j < embeddingData.length; j++) {
                        const item1 = embeddingData[i];
                        const item2 = embeddingData[j];
                        
                        if (!item1.vector || !item2.vector) continue;
                        
                        const distance = calculateDistance(item1.vector, item2.vector, metric);
                        
                        if (distance < thresholdDistance) {
                            const similarity = 1 - (distance / thresholdDistance);
                            edges.push({
                                id: `${item1.id}-${item2.id}`,
                                source: item1.id,
                                target: item2.id,
                                data: { 
                                    distance: distance.toFixed(3),
                                    metric: metric
                                },
                                style: { 
                                    stroke: '#94a3b8', 
                                    strokeWidth: Math.max(1, similarity * 3),
                                    opacity: 0.6 
                                },
                            });
                        }
                    }
                }
                return edges;
            }, [threshold, distanceMetric, calculateDistance]);

            const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
            const [edges, setEdges, onEdgesChange] = useEdgesState([]);
            
            // Function to reset node positions
            const handleResetPositions = useCallback(() => {
                setNodes(nds => 
                    nds.map(node => ({
                        ...node,
                        position: originalNodePositions[node.id] || node.position
                    }))
                );
                
                // Reset edges if similarity is shown
                if (showSimilarity) {
                    setEdges(calculateSimilarityEdges(distanceMetric));
                }
                
                // Clear selected node
                setSelectedNode(null);
            }, [originalNodePositions, setNodes, showSimilarity, calculateSimilarityEdges, distanceMetric, setEdges]);

            // Filter nodes by category
            const filteredNodes = useMemo(() => {
                if (selectedCategory === 'all') return nodes;
                return nodes.filter(node => node.data.category === selectedCategory);
            }, [nodes, selectedCategory]);

            // Handle similarity toggle
            const handleSimilarityToggle = useCallback(() => {
                if (!showSimilarity) {
                    setEdges(calculateSimilarityEdges(distanceMetric));
                } else {
                    setEdges([]);
                }
                setShowSimilarity(!showSimilarity);
            }, [showSimilarity, calculateSimilarityEdges, distanceMetric, setEdges]);

            // Handle node click
            const onNodeClick = useCallback((event, node) => {
                setSelectedNode(node);
                
                if (showSimilarity) {
                    setEdges(prevEdges => 
                        prevEdges.map(edge => {
                            const isConnected = edge.source === node.id || edge.target === node.id;
                            return {
                                ...edge,
                                style: {
                                    ...edge.style,
                                    stroke: isConnected ? '#f59e0b' : '#94a3b8',
                                    strokeWidth: isConnected ? 4 : edge.style.strokeWidth,
                                    opacity: isConnected ? 1 : 0.3,
                                    label: isConnected ? edge.data.distance : ''
                                },
                                // Only show labels for connected edges
                                label: isConnected ? edge.data.distance : ''
                            };
                        })
                    );
                }
            }, [showSimilarity, setEdges]);

            const categories = ['all', 'programming', 'animals', 'food', 'transport'];

            // Initialize and update 3D graph
            const initializeGraph3D = useCallback(() => {
                if (!is3DView || !graphRef.current) return;
                
                // Clear any existing graph
                if (graph3DInstanceRef.current) {
                    graphRef.current.innerHTML = '';
                }
                
                // Filter nodes by category if needed
                let graphData = { nodes: [], links: [] };
                const filteredData = selectedCategory === 'all' 
                    ? embeddingData 
                    : embeddingData.filter(item => item.category === selectedCategory);
                
                // Prepare nodes for 3D graph
                graphData.nodes = filteredData.map(item => ({
                    id: item.id,
                    name: item.label,
                    category: item.category,
                    color: item.color,
                    val: 2, // Node size
                    vector: item.vector,
                    x: item.x / 4, // Scale down for better 3D view
                    y: -item.y / 4, // Invert Y for 3D coordinate system
                    z: item.z / 4
                }));
                
                // Add links if similarity is enabled
                if (showSimilarity) {
                    // Calculate links based on distance metric
                    const links = [];
                    const maxDistance = {
                        euclidean: 2.0,
                        cosine: 1.0,
                        dot: 1.0
                    };
                    
                    const thresholdDistance = threshold * maxDistance[distanceMetric];
                    
                    for (let i = 0; i < filteredData.length; i++) {
                        for (let j = i + 1; j < filteredData.length; j++) {
                            const item1 = filteredData[i];
                            const item2 = filteredData[j];
                            
                            if (!item1.vector || !item2.vector) continue;
                            
                            const distance = calculateDistance(item1.vector, item2.vector, distanceMetric);
                            
                            if (distance < thresholdDistance) {
                                const similarity = 1 - (distance / thresholdDistance);
                                links.push({
                                    source: item1.id,
                                    target: item2.id,
                                    distance: distance,
                                    similarity: similarity,
                                    width: Math.max(1, similarity * 5),
                                    color: '#94a3b8',
                                    opacity: 0.6
                                });
                            }
                        }
                    }
                    
                    graphData.links = links;
                }
                
                // Initialize 3D force graph
                const Graph = ForceGraph3D()(graphRef.current)
                    .graphData(graphData)
                    .nodeLabel(node => `${node.name} (${node.category})`)
                    .nodeColor(node => node.color)
                    .nodeThreeObject(node => {
                        // Create a sphere for the node
                        const sphere = new THREE.Mesh(
                            new THREE.SphereGeometry(node.val),
                            new THREE.MeshLambertMaterial({ color: node.color, transparent: true, opacity: 0.8 })
                        );
                        
                        // Add text label
                        const sprite = new SpriteText(node.name);
                        sprite.color = '#ffffff';
                        sprite.backgroundColor = node.color;
                        sprite.padding = 2;
                        sprite.textHeight = 3;
                        sprite.position.y = 4;
                        
                        // Create a group to hold both objects
                        const group = new THREE.Group();
                        group.add(sphere);
                        group.add(sprite);
                        
                        return group;
                    })
                    .linkWidth(link => link.width)
                    .linkColor(link => link.color)
                    .linkOpacity(0.6)
                    .linkLabel(link => `Distance: ${link.distance.toFixed(3)}`)
                    .linkDirectionalParticles(link => link.similarity * 4)
                    .linkDirectionalParticleWidth(2)
                    .linkDirectionalParticleColor(() => '#ffffff')
                    .onNodeClick(node => {
                        // Highlight connections on click
                        const links = Graph.graphData().links;
                        Graph.linkColor(link => 
                            (link.source.id === node.id || link.target.id === node.id) ? '#f59e0b' : '#94a3b8'
                        );
                        Graph.linkWidth(link => 
                            (link.source.id === node.id || link.target.id === node.id) ? link.width * 1.5 : link.width
                        );
                        Graph.linkOpacity(link => 
                            (link.source.id === node.id || link.target.id === node.id) ? 1 : 0.3
                        );
                        
                        // Set link label visibility based on connection to selected node
                        Graph.linkLabel(link => {
                            if (link.source.id === node.id || link.target.id === node.id) {
                                return `Distance: ${link.distance.toFixed(3)}`;
                            } else {
                                return null; // Hide labels for other links
                            }
                        });
                        
                        // Update selected node info
                        setSelectedNode({
                            id: node.id,
                            data: {
                                label: node.name,
                                category: node.category,
                                vector: node.vector
                            }
                        });
                    });
                
                // Save reference to the graph instance
                graph3DInstanceRef.current = Graph;
                
                // Adjust camera position for better viewing angle
                Graph.cameraPosition({ x: 0, y: 0, z: 300 });
            }, [is3DView, selectedCategory, showSimilarity, distanceMetric, threshold]);
            
            // Update 3D graph when filters change
            const updateGraph3D = useCallback((category = selectedCategory, metric = distanceMetric, customThreshold = threshold) => {
                if (!is3DView || !graph3DInstanceRef.current) return;
                
                initializeGraph3D();
            }, [is3DView, selectedCategory, distanceMetric, threshold, initializeGraph3D]);
            
            // Reset 3D graph to original positions
            const resetGraph3D = useCallback(() => {
                if (!is3DView || !graph3DInstanceRef.current) return;
                
                // Re-initialize the graph to reset positions
                initializeGraph3D();
                
                // Clear selected node
                setSelectedNode(null);
            }, [is3DView, initializeGraph3D]);
            
            // Update 3D graph when view mode changes
            React.useEffect(() => {
                if (is3DView) {
                    initializeGraph3D();
                }
            }, [is3DView, initializeGraph3D]);

            return (
                <div style={{ width: '100vw', height: '100vh', background: '#f8fafc' }}>
                    {/* Control Panel */}
                    <div className="control-panel">
                        <h2 style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '12px', color: '#374151' }}>
                            AI Embeddings Visualizer
                        </h2>
                        
                        <div className="control-group">
                            <label className="control-label">View Mode:</label>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button
                                    onClick={() => setIs3DView(false)}
                                    className={`control-button ${!is3DView ? 'active' : ''}`}
                                    style={{ 
                                        flex: 1,
                                        backgroundColor: !is3DView ? '#3b82f6' : '#e5e7eb', 
                                        color: !is3DView ? 'white' : '#374151', 
                                        padding: '6px 8px',
                                        borderRadius: '6px',
                                        border: 'none',
                                        fontSize: '14px',
                                        fontWeight: '500',
                                        cursor: 'pointer'
                                    }}
                                >
                                    2D
                                </button>
                                <button
                                    onClick={() => {
                                        setIs3DView(true);
                                        // Initialize 3D graph after state update
                                        setTimeout(initializeGraph3D, 0);
                                    }}
                                    className={`control-button ${is3DView ? 'active' : ''}`}
                                    style={{ 
                                        flex: 1,
                                        backgroundColor: is3DView ? '#3b82f6' : '#e5e7eb', 
                                        color: is3DView ? 'white' : '#374151', 
                                        padding: '6px 8px',
                                        borderRadius: '6px',
                                        border: 'none',
                                        fontSize: '14px',
                                        fontWeight: '500',
                                        cursor: 'pointer'
                                    }}
                                >
                                    3D
                                </button>
                            </div>
                        </div>
                        
                        <div className="control-group">
                            <label className="control-label">Category Filter:</label>
                            <select 
                                value={selectedCategory} 
                                onChange={(e) => {
                                    setSelectedCategory(e.target.value);
                                    if (is3DView) {
                                        updateGraph3D(e.target.value);
                                    }
                                }}
                                className="control-select"
                            >
                                {categories.map(cat => (
                                    <option key={cat} value={cat}>
                                        {cat.charAt(0).toUpperCase() + cat.slice(1)}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div className="control-group">
                            <label className="control-label">Distance Metric:</label>
                            <select 
                                value={distanceMetric} 
                                onChange={(e) => {
                                    setDistanceMetric(e.target.value);
                                    if (showSimilarity) {
                                        if (is3DView) {
                                            updateGraph3D(selectedCategory, e.target.value);
                                        } else {
                                            setEdges(calculateSimilarityEdges(e.target.value));
                                        }
                                    }
                                }}
                                className="control-select"
                            >
                                <option value="euclidean">Euclidean Distance</option>
                                <option value="cosine">Cosine Similarity</option>
                                <option value="dot">Dot Product</option>
                            </select>
                        </div>

                        <div className="control-group">
                            <label className="control-label">Threshold: {threshold.toFixed(2)}</label>
                            <input 
                                type="range" 
                                min="0.1" 
                                max="1.0" 
                                step="0.05"
                                value={threshold}
                                onChange={(e) => {
                                    const newThreshold = parseFloat(e.target.value);
                                    setThreshold(newThreshold);
                                    if (showSimilarity) {
                                        if (is3DView) {
                                            updateGraph3D(selectedCategory, distanceMetric, newThreshold);
                                        } else {
                                            setEdges(calculateSimilarityEdges(distanceMetric));
                                        }
                                    }
                                }}
                                style={{ width: '100%' }}
                            />
                        </div>
                        
                        <div className="control-group">
                            <label className="control-checkbox">
                                <input
                                    type="checkbox"
                                    checked={showSimilarity}
                                    onChange={() => {
                                        const newValue = !showSimilarity;
                                        setShowSimilarity(newValue);
                                        if (is3DView) {
                                            if (newValue) {
                                                updateGraph3D(selectedCategory, distanceMetric);
                                            } else {
                                                updateGraph3D(selectedCategory, null);
                                            }
                                        } else {
                                            handleSimilarityToggle();
                                        }
                                    }}
                                />
                                <span style={{ fontSize: '14px', fontWeight: '600', color: '#374151' }}>
                                    Show Similarity Connections
                                </span>
                            </label>
                        </div>

                        <div className="control-group">
                            <button 
                                onClick={() => {
                                    if (is3DView) {
                                        resetGraph3D();
                                    } else {
                                        handleResetPositions();
                                    }
                                }}
                                className="control-button"
                                style={{ 
                                    backgroundColor: '#3b82f6', 
                                    color: 'white', 
                                    padding: '8px 12px',
                                    borderRadius: '6px',
                                    border: 'none',
                                    fontSize: '14px',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    width: '100%',
                                    marginTop: '8px'
                                }}
                            >
                                Reset Positions
                            </button>
                        </div>
                    </div>

                    {/* Info Panel */}
                    <div className="info-panel">
                        <h3 style={{ fontWeight: 'bold', color: '#374151', marginBottom: '8px' }}>
                            Understanding Embeddings
                        </h3>
                        <p style={{ fontSize: '14px', color: '#6B7280', marginBottom: '8px' }}>
                            Embeddings represent concepts as points in vector space. Similar concepts cluster together.
                        </p>
                        <ul style={{ fontSize: '12px', color: '#6B7280', margin: 0, paddingLeft: '16px' }}>
                            <li>Distance = Semantic similarity</li>
                            <li>Clusters = Related concepts</li>
                            <li>Click nodes to explore connections</li>
                        </ul>
                        
                        <div style={{ marginTop: '12px', borderTop: '1px solid #e5e7eb', paddingTop: '8px' }}>
                            <h4 style={{ fontSize: '14px', fontWeight: '600', margin: '0 0 6px 0' }}>Distance Metrics:</h4>
                            <div style={{ fontSize: '12px', color: '#6B7280' }}>
                                <p style={{ margin: '0 0 4px 0' }}>
                                    <strong>Euclidean:</strong> Physical distance between points in space.
                                </p>
                                <p style={{ margin: '0 0 4px 0' }}>
                                    <strong>Cosine:</strong> Angle between vectors (direction similarity).
                                </p>
                                <p style={{ margin: '0 0 4px 0' }}>
                                    <strong>Dot Product:</strong> Product of magnitudes and cosine of angle.
                                </p>
                            </div>
                        </div>
                        
                        {selectedNode && (
                            <div style={{ marginTop: '12px', padding: '8px', background: '#f9fafb', borderRadius: '6px' }}>
                                <h4 style={{ fontSize: '14px', fontWeight: '600', margin: '0 0 4px 0' }}>Selected:</h4>
                                <p style={{ fontSize: '12px', color: '#6B7280', margin: 0 }}>
                                    <strong>{selectedNode.data.label}</strong><br/>
                                    Category: {selectedNode.data.category}<br/>
                                    Vector: [{selectedNode.data.vector ? selectedNode.data.vector.map(v => v.toFixed(2)).join(', ') : ''}]
                                </p>
                                
                                {showSimilarity && !is3DView && (
                                    <div style={{ marginTop: '8px', fontSize: '11px' }}>
                                        <h5 style={{ fontSize: '12px', margin: '0 0 4px 0', fontWeight: '600' }}>Distances ({distanceMetric}):</h5>
                                        <ul style={{ margin: '0', padding: '0 0 0 12px' }}>
                                            {edges
                                                .filter(edge => edge.source === selectedNode.id || edge.target === selectedNode.id)
                                                .map(edge => {
                                                    const connectedId = edge.source === selectedNode.id ? edge.target : edge.source;
                                                    const connectedNode = nodes.find(n => n.id === connectedId);
                                                    return (
                                                        <li key={edge.id}>
                                                            {connectedNode.data.label}: {edge.data.distance}
                                                        </li>
                                                    );
                                                })}
                                        </ul>
                                    </div>
                                )}
                                
                                {showSimilarity && is3DView && graph3DInstanceRef.current && (
                                    <div style={{ marginTop: '8px', fontSize: '11px' }}>
                                        <h5 style={{ fontSize: '12px', margin: '0 0 4px 0', fontWeight: '600' }}>Distances ({distanceMetric}):</h5>
                                        <ul style={{ margin: '0', padding: '0 0 0 12px' }}>
                                            {graph3DInstanceRef.current.graphData().links
                                                .filter(link => link.source.id === selectedNode.id || link.target.id === selectedNode.id)
                                                .map((link, idx) => {
                                                    const connectedId = link.source.id === selectedNode.id ? link.target.id : link.source.id;
                                                    const connectedNode = link.source.id === selectedNode.id ? link.target : link.source;
                                                    return (
                                                        <li key={`3d-link-${idx}`}>
                                                            {connectedNode.name}: {link.distance.toFixed(3)}
                                                        </li>
                                                    );
                                                })}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Legend */}
                    <div className="legend">
                        <h4 style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px' }}>Categories:</h4>
                        <div className="legend-item">
                            <div className="legend-color" style={{ backgroundColor: '#3b82f6' }}></div>
                            <span style={{ fontSize: '12px' }}>Programming</span>
                        </div>
                        <div className="legend-item">
                            <div className="legend-color" style={{ backgroundColor: '#10b981' }}></div>
                            <span style={{ fontSize: '12px' }}>Animals</span>
                        </div>
                        <div className="legend-item">
                            <div className="legend-color" style={{ backgroundColor: '#f59e0b' }}></div>
                            <span style={{ fontSize: '12px' }}>Food</span>
                        </div>
                        <div className="legend-item">
                            <div className="legend-color" style={{ backgroundColor: '#ef4444' }}></div>
                            <span style={{ fontSize: '12px' }}>Transportation</span>
                        </div>
                        
                        <div style={{ marginTop: '10px', borderTop: '1px solid #e5e7eb', paddingTop: '8px' }}>
                            <h4 style={{ fontSize: '14px', fontWeight: '600', marginBottom: '4px' }}>Current Metric:</h4>
                            <div style={{ fontSize: '12px' }}>
                                <strong>{distanceMetric.charAt(0).toUpperCase() + distanceMetric.slice(1)}</strong>
                                <div style={{ fontSize: '10px', color: '#6B7280', marginTop: '2px' }}>
                                    Threshold: {threshold.toFixed(2)}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Visualization - either 2D ReactFlow or 3D ForceGraph */}
                    {!is3DView ? (
                        <ReactFlow
                            nodes={filteredNodes}
                            edges={edges}
                            onNodesChange={onNodesChange}
                            onEdgesChange={onEdgesChange}
                            onNodeClick={onNodeClick}
                            nodeTypes={nodeTypes}
                            fitView
                            attributionPosition="bottom-right"
                        >
                            <Background color="#e2e8f0" gap={20} />
                            <Controls />
                            <MiniMap 
                                nodeColor={(node) => node.data.color}
                                nodeStrokeWidth={3}
                                zoomable
                                pannable
                            />
                        </ReactFlow>
                    ) : (
                        <div 
                            ref={graphRef} 
                            style={{ 
                                position: 'absolute', 
                                top: 0, 
                                left: 0, 
                                width: '100%', 
                                height: '100%', 
                                zIndex: 5 
                            }}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.render(<EmbeddingVisualizer />, document.getElementById('root'));
    </script>
</body>
</html>